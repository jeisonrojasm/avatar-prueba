<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.min.js"
        integrity="sha512-n8IpKWzDnBOcBhRlHirMZOUvEq2bLRMuJGjuVqbzUJwtTsgwOgK5aS0c1JA647XWYfqvXve8k3PtZdzpipFjgg=="
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/fflate"></script>
    <!-- AFRAME EXTRAS (para animaciones)-->
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>

    <script src="https://cdn.rawgit.com/mrdoob/three.js/r118/examples/js/exporters/GLTFExporter.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <script>
        // Crear la escena, la cámara y el renderizador
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var renderer = new THREE.WebGLRenderer({ alpha: true });

        // Configurar el tamaño del renderizador y agregarlo al cuerpo del HTML
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Agregar una luz a la escena
        var light = new THREE.AmbientLight(0xffffff); // Luz blanca ambiental
        scene.add(light);

        // Crear la variable mixer
        // var mixer = new THREE.AnimationMixer(scene);

        // Cargar los archivos glb
        var loaderAnimacion = new THREE.GLTFLoader();
        var loaderModelo = new THREE.GLTFLoader();
        loaderAnimacion.load('./assets/dancing.glb', function (animacion) {
            loaderModelo.load('./assets/modelo.glb', function (modelo) {

                modelo.scene.scale.set(4, 4, 4);
                camera.position.set(0, 0, 10);

                for (let i = 0; i < animacion.animations[0].tracks.length; i++) {
                    const str = animacion.animations[0].tracks[i].name;
                    const newStr = str.replace('mixamorig', '');
                    animacion.animations[0].tracks[i].name = newStr;
                }

                // Extraer las animaciones del modelo animado y guardarlas en una instancia de AnimationClip
                const nombreAnimacion = animacion.animations[0].name;
                const duracionAnimacion = animacion.animations[0].duration;
                const tracksAnimacion = animacion.animations[0].tracks;
                const animation = new THREE.AnimationClip(nombreAnimacion, duracionAnimacion, tracksAnimacion);

                // Agregar las animaciones al modelo
                modelo.animations[0] = animation;

                console.log(modelo);

                // Reproducir la animación en bucle
                var mixer = new THREE.AnimationMixer(modelo.scene);
                var actionAnimacion = mixer.clipAction(animacion.animations[0]);
                actionAnimacion.play();
                actionAnimacion.setLoop(THREE.LoopRepeat);

                // Agregar el modelo a la escena
                scene.add(modelo.scene);

                var clock = new THREE.Clock();
                function animate() {
                    requestAnimationFrame(animate);

                    // Actualizar el objeto Mixer con el tiempo transcurrido
                    mixer.update(clock.getDelta());

                    renderer.render(scene, camera);
                }
                animate();

                // Crea una instancia de GLTFExporter
                var exporter = new THREE.GLTFExporter();

                // Exporta el modelo
                exporter.parse(modelo.scene, function (result) {
                    const url = URL.createObjectURL(new Blob([result], { type: 'model/gltf-binary' }));
                    console.log(result);
                    // Crea un elemento <a> para descargar el archivo
                    var link = document.createElement('a');
                    link.href = url;
                    link.download = 'nuevo_nombre.glb';
                    document.body.appendChild(link);

                    // Descarga el archivo
                    link.click();

                    // Elimina el elemento <a>
                    document.body.removeChild(link);

                    // Liberar la memoria de la URL
                    URL.revokeObjectURL(url);

                }, { binary: true });

            }, undefined, function (error) {
                console.error(error);
            });
        });
    </script>
    
</body>

</html>